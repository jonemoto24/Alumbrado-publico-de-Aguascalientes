<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name=" descripcion" content="Reporte de alumbrado público de Aguascalientes">
    <meta name=" keywords" content="Alumbrado público, Aguascalientes, Reporte, Ciudadano">
    <meta name=" robots" content="index, follow">
    <meta name=" author" content="Gobierno de Aguascalientes">
    <link rel="icon" type="image/x-icon" href="Secretaria.jpg">
    <link rel="icon" href="/icono-32x32.png" sizes="32x32" type="image/jpg">
    <link rel="apple-touch-icon" href="/icono-180x180.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <title>Alumbrado público de Aguascalientes</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="validacionAcceso.js"></script>
</head>
<body>
  
    <header>
        <h1>Alumbrado Público de Aguascalientes</h1>
        <img src="Aguascalientes.png" alt="Logo" class="header-logo">
    </header> 

    <main> 
        <section class="reporte-banner">
            <h1>Información del reporte</h1>
        </section>

        <section id="Información del reporte">
            <form id="reporteForm">
  <fieldset>
    <legend>Datos del ciudadano</legend>
    <label for="nombres">Nombres:</label>
    <input type="text" id="nombres" name="nombres" required>

    <label for="apellidos">Apellidos:</label>
    <input type="text" id="apellidos" name="apellidos" required>

    <label for="Telefono">Teléfono:</label>
    <input type="tel" id="Telefono" name="Telefono" required>
  </fieldset>

  <fieldset>
    <legend>Ubicación del reporte</legend>
    <label for="ubicacion">Colonia o Fraccionamiento:</label>
    <input list="colonias" id="ubicacion" name="ubicacion" required>
    <datalist id="colonias"></datalist>

<label for="calle">Calle principal:</label>
<input list="callesList" id="calle" name="calle" required>
<datalist id="callesList"></datalist>

    <label for="entreCalles">Entre qué calles:</label>
    <input list="entreCalles" id="entreCalles" name="entreCalles" required>

    <label for="CodigoPostal">Código Postal: (Opcional)</label>
<input list="codigosPostales" id="CodigoPostal" name="CodigoPostal" required readonly>
<datalist id="codigosPostales"></datalist>


  </fieldset>

  <fieldset>

    <legend>Detalles del reporte</legend>
    <label for="Pregunta">¿Tiene varias luminarias defectuosas?</label>
    <select id="Pregunta" name="Pregunta" required>
      <option value="" disabled selected>Seleccione una opción</option>
      <option value="Sí">Sí</option>
      <option value="No">No</option>
    </select>

    <label for="Cantidad">Cantidad de luminarias defectuosas:</label>
    <input type="number" id="Cantidad" name="Cantidad" min="1" required>

    <label for="Tiempo">Tiempo que han estado defectuosas:</label>
    <input type="text" id="Tiempo" name="Tiempo" required>
  </fieldset>

  <fieldset>

    <legend>Características de la falla</legend>

    <label for="PosibleFalla">Posible Falla:</label>
    <input list="fallasList" id="PosibleFalla" name="PosibleFalla" required>
    <datalist id="fallasList"></datalist>

    <label for="ES">Estado de la luminaria:</label>
    <select id="ES" name="ES" required>
      <option value="" disabled selected>Seleccione una opción</option>
      <option value="Sin daños">Sin daños</option>
      <option value="Quebrada">Quebrada</option>
      <option value="Rota">Rota</option>
      <option value="Quemada">Quemada</option>
      <option value="No hay luminaria">No hay luminaria</option>
      <option value="Poste esta dañado">Poste está dañado</option>
      <option value="Desconocida">Desconocida</option>
    </select>

    <label for="descripcion">Descripción de la falla: (Opcional)</label>
    <textarea id="descripcion" name="descripcion"></textarea>

  </fieldset>

  <button type="submit">Enviar reporte</button>

      </form>

<div style="text-align:center; margin-top: 20px;">
  <button onclick="mostrarMapa()">Acceder al mapa de luminarias</button>
</div>  

      <section class="imagen-add">
  <img src="Alumbrado.jpg" alt="Imagen de Alumbrado" class="imagen-add-logo">
</section>

        </section>
<section id="mapa" style="display:none;">
  <div style="text-align:center; margin:20px;">
    <h2>Acceso al mapa</h2>
    <input type="text" id="matricula" placeholder="Matrícula" />
    <input type="password" id="clave" placeholder="Clave" />
    <br />
    <button onclick="iniciar()">Entrar</button>
    <div id="mensaje" style="color:red; font-weight:bold;"></div>
  </div>

  <div class="controls" style="text-align:center; margin:20px; display:none;" id="botonesMapa">
    <button onclick="cargarLibreria('luminariasNorte.json')">Sector Norte</button>
    <button onclick="cargarLibreria('luminariasOriente.json')">Sector Oriente</button>
    <button onclick="cargarLibreria('luminariasSur.json')">Sector Sur</button>
    <button onclick="limpiarCircuitos()">Borrar Circuitos</button>
  </div>

  <div id="map" style="height:90vh; width:100%; display:none;"></div>
</section>

    </main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  function obtenerFolio() {
    let folioActual = localStorage.getItem("folioReporte");
    folioActual = folioActual ? parseInt(folioActual, 10) : 0;
    const folioFormateado = folioActual.toString().padStart(5, "0");
    localStorage.setItem("folioReporte", folioActual + 1);
    return folioFormateado;
  }

  function obtenerFechaHora() {
    return new Date().toLocaleString("es-MX", {
      timeZone: "America/Mexico_City",
      hour12: false
    });
  }

  function obtenerTurnoAutomatico() {
    const hora = new Date().getHours();
    if (hora >= 6 && hora < 14) return "Matutino";
    if (hora >= 14 && hora < 22) return "Vespertino";
    return "Nocturno";
  }

  function obtenerDatosFormulario(fechaHoraEnvio, turno) {
    return {
      
      "Fecha y hora de envío": fechaHoraEnvio,
      "Nombre(s)": document.getElementById("nombres").value,
      "Apellido(s)": document.getElementById("apellidos").value,
      "Teléfono": document.getElementById("Telefono").value,
      "Ubicación": document.getElementById("ubicacion").value,
      "Calle principal": document.getElementById("calle").value,
      "Entre que calles": document.getElementById("entreCalles").value,
      "Código Postal": document.getElementById("CodigoPostal").value,
      "¿Hay varias luminarias dañadas?": document.getElementById("Pregunta").value,
      "Cantidad de luminarias": document.getElementById("Cantidad")?.value || "N/A",
      "Tiempo dañadas": document.getElementById("Tiempo")?.value || "N/A",
      "Tipo de falla": document.getElementById("PosibleFalla").value,
      "Estado de la luminaria": document.getElementById("ES").value,
      "Descripción del problema": document.getElementById("descripcion").value,
      "Turno asignado": turno,
    };
  }

  function validarCamposObligatorios() {
    const campos = [
      "nombres", "apellidos", "Telefono", "ubicacion", "calle", "entreCalles",
      "Pregunta", "Cantidad", "Tiempo", "PosibleFalla"
    ];
    const faltantes = campos.filter(id => !document.getElementById(id)?.value.trim());
    return faltantes;
  }

  function generarExcelBlob(datos) {
  const hoja = XLSX.utils.json_to_sheet([datos]);
  const libro = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(libro, hoja, "Reporte");
  const excelBuffer = XLSX.write(libro, { bookType: "xlsx", type: "array" });
  return new Blob([excelBuffer], {
    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  });
}

function subirAAppsScript(blob, nombreArchivo) {
  const reader = new FileReader();
  reader.onload = function () {
    const base64 = reader.result.split(',')[1];
    const formData = new URLSearchParams();
    formData.append("archivo", base64);
    formData.append("nombre", nombreArchivo);

    fetch("https://script.google.com/macros/s/AKfycbwGb23Iamb8Xd4eqJdTHSitNJF3hGRModqLq22jGpXLNwa1i6vmm5ihd8ocDt0xicyY/exec", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Archivo subido a Drive correctamente.");
      } else {
        alert("Error al subir: " + data.error);
      }
    })
    .catch(err => {
      console.error("Error en la subida:", err);
      alert("No se pudo subir el archivo.");
    });
  };
  reader.readAsDataURL(blob);
}

  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("reporteForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const faltantes = validarCamposObligatorios();
      if (faltantes.length > 0) {
        alert("Por favor completa todos los campos requeridos.");
        return;
      }

      const folio = obtenerFolio();
      const fechaHoraEnvio = obtenerFechaHora();
      const turno = obtenerTurnoAutomatico();
      const datosFormulario = obtenerDatosFormulario(fechaHoraEnvio, turno);

      try {
  const blob = generarExcelBlob(datosFormulario);
  const nombreArchivo = `REPORTE_${datosFormulario["Ubicación"]}_${datosFormulario["Calle principal"]}_${datosFormulario["Tipo de falla"]}_${datosFormulario["Estado de la luminaria"]}.xlsx`;
  subirAAppsScript(blob, nombreArchivo);
  alert(`Reporte generado para el turno ${turno}`);
} catch (error) {
  console.error("Error al generar o subir el Excel:", error);
  alert("Hubo un problema. Verifica los datos e intenta nuevamente.");
}
    });
  });
</script>
 
<script>
async function cargarColonias() {
  const res = await fetch('colonias.json');
  const colonias = await res.json();
  const datalist = document.getElementById('colonias');
  colonias.forEach(colonia => {
    const option = document.createElement('option');
    option.value = colonia;
    datalist.appendChild(option);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  cargarColonias();
  cargarFallas();

  document.getElementById('ubicacion').addEventListener('change', async function () {
    const colonia = this.value;

    const callesRes = await fetch('calles.json');
    const callesData = await callesRes.json();
    const calles = callesData[colonia] || [];

    const callesList = document.getElementById('callesList');
    callesList.innerHTML = '';
    calles.forEach(calle => {
      const option = document.createElement('option');
      option.value = calle;
      callesList.appendChild(option);
    });

    const cpRes = await fetch('codigos_postales.json');
    const cpData = await cpRes.json();
    const cp = cpData[colonia];
    const cpList = document.getElementById('codigosPostales');
    cpList.innerHTML = '';
    if (cp) {
      const option = document.createElement('option');
      option.value = cp;
      cpList.appendChild(option);
      document.getElementById('CodigoPostal').value = cp;
    }
});
});

async function cargarFallas() {
  const res = await fetch('fallas.json');
  const fallas = await res.json();
  const datalist = document.getElementById('fallasList');
  fallas.forEach(falla => {
    const option = document.createElement('option');
    option.value = falla;
    datalist.appendChild(option);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  cargarFallas();
});

let listaAutorizados = [];
let datosCargados = false;
let map, grupoCentros, grupoCircuitos;

const iconoNegro = L.icon({
  iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-black.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
});

const iconoAzul = L.icon({
  iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-blue.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
});

// Cargar lista de autorizados
fetch('Acceso.json')
  .then(res => res.json())
  .then(data => {
    listaAutorizados = data;
    datosCargados = true;
  })
  .catch(err => console.error("Error al cargar autorizados:", err));

// Mostrar sección del mapa
function mostrarMapa() {
  document.getElementById('mapa').scrollIntoView({ behavior: 'smooth' });
  document.getElementById('mapa').style.display = 'block';
}

// Validar acceso
function validarAcceso() {
  if (!datosCargados) {
    document.getElementById('mensaje').textContent = "Datos aún no cargados. Intenta en unos segundos.";
    return false;
  }

  const matricula = document.getElementById('matricula').value.trim().toLowerCase();
  const clave = document.getElementById('clave').value.trim();

  return listaAutorizados.some(p =>
    p.matricula.toLowerCase() === matricula && p.clave === clave
  );
}

// Iniciar mapa si acceso es válido
function iniciar() {
  const mensaje = document.getElementById('mensaje');
  mensaje.textContent = '';

  if (validarAcceso()) {
    document.getElementById('botonesMapa').style.display = 'block';
    document.getElementById('map').style.display = 'block';
    inicializarMapa();
  } else {
    mensaje.textContent = "Acceso denegado. Verifica tus datos.";
  }
}

// Inicializar mapa
function inicializarMapa() {
  if (map) return; // evita reinicializar

  map = L.map('map').setView([21.8784, -102.2957], 13);

  L.tileLayer('https://api.maptiler.com/maps/basic-v2/{z}/{x}/{y}.png?key=TxkoiifB5tCb5afunfk2', {
    attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 25
  }).addTo(map);

  grupoCentros = L.layerGroup().addTo(map);
  grupoCircuitos = L.layerGroup().addTo(map);
}

// Cargar centros de carga
function cargarLibreria(archivo) {
  if (!grupoCentros || !grupoCircuitos) {
    alert("El mapa aún no está listo. Accede primero con tu matrícula y clave.");
    return;
  }

  fetch(archivo)
    .then(res => res.json())
    .then(sector => {
      grupoCentros.clearLayers();
      grupoCircuitos.clearLayers();

      sector.centros.forEach(c => {
        const marker = L.marker([c.lat, c.lng], { icon: iconoNegro }).addTo(grupoCentros);
        marker.bindPopup(`
          <b>${c.nombre}</b><br>
          <button onclick="cargarCircuitos('${c.archivo}', '${c.nombre}')">Ver circuito</button>
        `);
      });
    })
    .catch(err => alert("Error al cargar la librería: " + err));
}

// Cargar luminarias del circuito
function cargarCircuitos(archivoCircuitos, centroNombre) {
  fetch(archivoCircuitos)
    .then(res => res.json())
    .then(circuitos => {
      grupoCircuitos.clearLayers();

      const circuitosFiltrados = circuitos.circuitos.filter(c => c.centro === centroNombre);

      circuitosFiltrados.forEach(c => {
        c.puntos.forEach(p => {
          L.marker([p.lat, p.lng], { icon: iconoAzul })
            .bindPopup(`<b>${p.nombre}</b><br>${c.nombre}`)
            .addTo(grupoCircuitos);
        });

        const coords = c.puntos.map(p => [p.lat, p.lng]);
        L.polyline(coords, { color: 'blue', weight: 3 }).addTo(grupoCircuitos);
      });
    })
    .catch(err => alert("Error al cargar circuitos: " + err));
}

// Limpiar luminarias
function limpiarCircuitos() {
  grupoCircuitos.clearLayers();
}


</script>
</body>
</html>

